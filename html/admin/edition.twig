{% extends "assets/template.twig" %}
{% block htmlIncludes %}
    <!--Date picker-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js" integrity="sha256-VrmtNHAdGzjNsUNtWYG55xxE9xDTz4gF63x/prKXKH0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js" integrity="sha256-5YmaxAwMjIpMrVlK84Y/+NjCpKnFYa8bWWBbUHSBGfU=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css" integrity="sha256-yMjaV542P+q1RnH6XByCPDfUFhmOafWbeLPmqKh11zo=" crossorigin="anonymous" />


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha256-KM512VNnjElC30ehFwehXjx1YCHPiQkOPmqnrWtpccM=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha256-rByPlHULObEjJ6XQxW/flG2r+22R5dKiAoef+aXWfik=" crossorigin="anonymous" />
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-md-4 col-sm-12">
        <div class="box box-default">
            <div class="box-header with-border">
                <h3 class="box-title">
                    Edition Details
                </h3>

                <div class="box-tools pull-right">
                    {% if edition.editions_show == 1 and date(edition.editions_published) < date() %}
                        <a href="{{ CONFIG.ROOTFRONTENDURL }}/edition/{{ edition.editions_slug }}"
                           type="button" title="View on website" class="btn btn-default btn-sm" target="_blank">View on site</a>
                    {% endif %}
                    {% if 51|permissions %}
                    <button title="Save" id="saveButton" class="btn btn-success"><i class="fa fa-floppy-o"></i></button>
                    {% endif %}
                </div>

            </div>
            <div class="box-body">
                <div class="form-group">
                    <label>Name</label>
                    <textarea id="name" style="resize: none;" rows="2" placeholder="23 November 1964" class="form-control">{{ edition.editions_name|raw }}</textarea>
                    <i>"23 November 1964" or "Freshers Supplement 2020" etc.</i>
                </div>
                <div class="form-group">
                    <label>Print Edition &numero;</label>
                    <input id="printnumber" type="number" placeholder="001" min="1" class="form-control" value="{{ edition.editions_printNumber }}" />
                    <i>Only set this for conventional print editions</i>
                </div>
                <div class="form-group">
                    <label>Strapline</label>
                    <textarea id="excerpt" style="resize: none;" rows="2" placeholder="Strapline displays underneath the title of the edition - not normally used unless the edition has special significance" class="form-control">{{ edition.editions_excerpt|raw }}</textarea>
                </div>
                <div class="form-group">
                    <label>Publication date</label>
                    <input type='text' class="form-control" id="published" />
                    <p style="font-style: italic;">Editions with a status of "published" and a date in the future will be published upto two hours after the date and time selected due to cache constraints</p>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select class="form-control" id="status">
                        <option value="1">Draft</option>
                        <option value="2" {{ edition.editions_show == 1 and edition.editions_showHome == 0 ? 'selected' : '' }}>Published only</option>
                        <option value="3" {{ edition.editions_show == 1 and edition.editions_showHome == 1 ? 'selected' : '' }}>Published on Homepage</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select class="form-control" id="type">
                        {% for type in editionTypes %}
                            {% set type = type.editions_type %}
                            <option {{ edition.editions_type == type ? ' selected': ''}} value="{{ type }}">{{ type }}</option>
                        {% endfor %}
                    </select>
                </div>
                <hr/>
                <div class="form-group">
                    <label>Slug</label>
                    <textarea id="slug" disabled style="resize: none;" rows="2" class="form-control">{{ edition.editions_slug }}</textarea>
                    <p style="font-style: italic;">Contact support@nouse.co.uk for a custom URL</p>
                </div>
            </div>
            <div class="box-footer">
                <b>Tips</b>
                <ul>
                    <li>Generate a PDF with the entire edition as one file, with spreads split into two pages</li>
                    <li>Generate the cover as a JPEG export and set it as the thumbnail</li>
                </ul>
            </div>
            <div class="overlay loadingoverlay">
                <i class="fa fa-refresh fa-spin"></i>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-12">
        <div class="box box-default">
            <div class="box-header with-border">
                <h3 class="box-title">
                    Thumbnail
                </h3>
                <div class="box-tools pull-right">
                </div>
            </div>
            <div class="box-body no-padding">
                <img src="{{ (edition.editions_thumbnail ? edition.editions_thumbnail|s3URL : "") }}" alt="Thumbnail" id="thumbnailImage" style="width: 100%; {% if edition.editions_thumbnail|length < 1 %}display: none;{% endif %}" />
            </div>
            <div class="box-footer">
                {% embed 'common/plugins/uppy.twig' with {'publicBool': true, 'type': 'EDITION-THUMBNAIL', 'paste': true, 'typeId': 4, 'subTypeId': edition.editions_id, 'imagesOnly': true, 'fileLimit': 1 } %}
                    {% block success %}
                        $("#thumbnailImage").attr("src",url);
                        thumbnailid = responseJson.id;
                        $("#thumbnailImage").show();
                    {% endblock %}
                {% endembed %}
                <p style="font-style: italic; margin-top: 4px;">To display correctly, thumbnails should be taller than they are wide. Portrait images of around 1:2 aspect ratio work well</p>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-12">
        <div class="box box-default">
            <div class="box-header with-border">
                <h3 class="box-title">
                    Compressed PDF
                </h3>
                <div class="box-tools pull-right">
                </div>
            </div>
            <div class="box-body">
                <a href="{{ edition.editions_pdf|s3URL }}" id="pdfLinkCompressed" style="{{ edition.editions_pdf|length < 1 ? 'display:none;' : '' }}" target="_blank" class="btn btn-default btn-lg"><i style="margin-right: 10px;" class="fa fa-file-pdf-o"></i>
                    {% set editionPdfData = edition.editions_pdf|s3DATA %}
                    {{ editionPdfData['data']['s3files_original_name'] }}</a>
            </div>
            <div class="box-footer">
                {% embed 'common/plugins/uppy.twig' with {'publicBool': true, 'type': 'EDITION-PDF', 'paste': false, 'typeId': 6, 'subTypeId': edition.editions_id, 'imagesOnly': false, 'fileLimit': 1 } %}
                    {% block success %}
                        $("#pdfLinkCompressed").attr("href",url);
                        pdffileid = responseJson.id;
                        $("#pdfLinkCompressed").show();
                    {% endblock %}
                {% endembed %}<p style="font-style: italic; margin-top: 4px;">This is a compressed version of the PDF suitable for downloading by end users<br/>Uploading a new PDF replaces the old one</p>

            </div>
        </div>
        <div class="box box-default">
            <div class="box-header with-border">
                <h3 class="box-title">
                    High Quality PDF Original
                </h3>
                <div class="box-tools pull-right">
                </div>
            </div>
            <div class="box-body">
                <a href="{{ edition.editions_pdfOriginal|s3URL }}" id="pdfLink" style="{{ edition.editions_pdfOriginal|length < 1 ? 'display:none;' : '' }}" target="_blank" class="btn btn-default btn-lg"><i style="margin-right: 10px;" class="fa fa-file-pdf-o"></i>
                    {% set editionPdfOrigData = edition.editions_pdfOriginal|s3DATA %}
                    {{ editionPdfOrigData['data']['s3files_original_name'] }}</a>
            </div>
            <div class="box-footer">
                {% embed 'common/plugins/uppy.twig' with {'publicBool': true, 'type': 'EDITION-PDF', 'paste': false, 'typeId': 5, 'subTypeId': edition.editions_id, 'imagesOnly': false, 'fileLimit': 1 } %}
                {% block success %}
                    $("#pdfLink").attr("href",url);
                    pdforigfileid = responseJson.id;
                    $("#pdfLink").show();
                {% endblock %}
                {% endembed %}<p style="font-style: italic; margin-top: 4px;">This is the raw PDF that comes of out the publishing software<br/>Uploading a new PDF replaces the old one</p>

            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="box box-success">
            <div class="box-header with-border">
                Featured Articles
            </div>
            <div class="box-body">
                <select id="featuredSelect" class="chooser form-control" multiple="multiple">
                    {% for article in edition.featuredArticles %}
                        <option selected value="{{ article.articles_id }}">{{ article.articlesDrafts_headline }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="box-footer">
                Consider the featured articles as a front cover - upto 16 articles can be featured
            </div>
        </div>
        <div class="box box-default">
            <div class="box-header with-border">
                <h3 class="box-title">
                    Articles in Edition
                </h3>
            </div>
            <div class="box-body table-responsive no-padding">
                {% if articles|length > 0 %}
                    <table class="table sticky-header" border="0" style="overflow-x: scroll;">
                        <thead>
                        <tr>
                            <th>Page</th>
                            <th>ID</th>
                            <th>Headline</th>
                            <th>Categories</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for article in articles %}
                            <tr
                                    {% if article.articles_showInLists != 1 and article.articles_showInSearch != 1 %}
                                class="danger"
                            {% elseif article.articles_showInLists != 1  %}
                                class="warning"
                                    {% endif %}>
                                <td>{{ article.articles_editionPage }}</td>
                                <td>{{ article.articles_id }}</td>
                                <td>{{ article.articlesDrafts_headline|raw }}
                                    {% if article.articles_showInLists != 1 and article.articles_showInSearch != 1 %}
                                        <span class="label label-danger">Draft</span><br/>
                                    {% elseif article.articles_showInLists != 1  %}
                                        <span class="label label-warning">Shown in search only</span><br/>
                                    {% endif %}

                                </td>
                                <td>
                                    {% for category in CATEGORIES %}
                                        {#Only display top level categories #}
                                        {% if category.categories_id in article.articles_categories %}
                                            <span class="label label-info"
                                            {% if category.categories_backgroundColor != "" %}
                                            style="background-color: #{{ category.categories_backgroundColor }} !important; color: #{{ category.categories_backgroundColorContrast }} !important;"
                                            {% endif %}>{{ category.categories_displayName }}</span><br/>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% if article.articles_showInSearch == 1 and date(article.articles_published) < date() %}
                                        <a href="{{ CONFIG.ROOTFRONTENDURL }}/{{ article.articles_published|date("Y/m/d") }}/{{ article.articles_slug }}"
                                           type="button" title="View on website" class="btn btn-default" target="_blank"><i
                                                    class="fa fa-eye"></i></a>
                                    {% endif %}
                                    {% if 32|permissions %}
                                        <a href="{{ CONFIG.ROOTBACKENDURL }}/article.php?id={{ article.articles_id }}"
                                           type="button" title="Edit" class="btn btn-default"><i
                                                    class="fa fa-pencil"></i></a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <center><p style="margin: 10px;">No articles<br/><i>Add articles to this edition by setting the edition on the left when editing an article</i></p></center>
                {% endif %}
            </div>
        </div>
    </div>
</div>
    <script>
        var thumbnailid = '{{ edition.editions_thumbnail }}'; //Used to store a new thumbnail if one is set
        var pdffileid = '{{ edition.editions_pdf }}';
        var pdforigfileid = '{{ edition.editions_pdfOriginal }}';
        $(document).ready(function () {
            $('#published').datetimepicker({
                date: "{{ (edition.editions_published == null ? "now"|date("Y-m-d H:i:s") : edition.editions_published) }}",
                locale: "en-gb",
                format: "D MMM YYYY h:mm:ss a"
            });
            $(".loadingoverlay").fadeOut();
            $("#saveButton").click(function () {
                $(".loadingoverlay").show();
                var actualOrder = [];
                var listNameToId = [];
                $("#featuredSelect").find("option").each(function(index) {
                    listNameToId[$( this ).html()] = $( this ).attr('value');
                });
                $("#featuredSelect").parent().find("li.select2-selection__choice").each(function(index) {
                    actualOrder.push(listNameToId[$( this ).attr('title')]);
                });
                $.ajax({
                    url: "{{ CONFIG.ROOTBACKENDURL }}/api/edition/edit.php",
                    type: 'POST',
                    dataType: "json",
                    data: {
                        "name": $("#name").val(),
                        "excerpt": $("#excerpt").val(),
                        "printnumber": $("#printnumber").val(),
                        "published":$("#published").val(),
                        "status":$("#status").val(),
                        "type":$("#type").val(),
                        "thumbnail": thumbnailid,
                        "pdfid": pdffileid,
                        "pdforigid": pdforigfileid,
                        "editionid": "{{ edition.editions_id }}",
                        "featured":actualOrder.join(","),
                    },
                    success: function (result) {
                        if (result.result) {
                            location.reload();
                        } else {
                            console.log(result);
                            bootbox.alert("Sorry - there was a problem saving your changes. Please check your internet connection and try again");
                        }
                    },
                    error: function () {
                        bootbox.alert("Sorry - there was a problem saving your changes. Please check your internet connection and try again");
                    }
                });
            });

            $("#featuredSelect").select2({
                tags: false,
                multiple: true,
                theme: "bootstrap",
                {% if 51|permissions != true %} disabled:true,{% endif %}
                minimumInputLength: 0,
                maximumSelectionLength: 16,
                width: '100%',
                minimumResultsForSearch: 1,
                placeholder: "Search for articles to feature at the top of the article",
                ajax: {
                    url: "{{ CONFIG.ROOTBACKENDURL }}/api/featured/articleSearchEdition.php?editionid={{ edition.editions_id }}",
                    dataType: "json",
                    type: "POST",
                    data: function (params) {
                        var queryParameters = {
                            term: params.term
                        }
                        return queryParameters;
                    },
                    processResults: function (data) {
                        if (data && data.result && data.response) {
                            return {
                                results: $.map(data.response, function (item) {
                                    return {
                                        text: item.articlesDrafts_headline,
                                        id: item.articles_id
                                    }
                                })
                            };
                        } else return {
                            results: []
                        };
                    }
                }
            });
            $("ul.select2-selection__rendered").sortable({
                containment: 'parent'
            });
        });
    </script>
{% endblock %}
