---
import Layout from "../layouts/Layout.astro";
import FeaturedArticles from "@components/FeaturedArticles.astro";
import type { featuredHome } from "@prisma/client";
import prisma from "../prisma";
import BannerEdition from "@components/BannerEdition.astro";
import Muse from "@components/Muse.astro";
import FeaturedSection from "@components/FeaturedSection.astro";
import { getFeaturedSectionsCategories } from "@components/utils/categories";

// Get featured articles ids
const featuredArticlesIds: featuredHome | null =
  await prisma.featuredHome.findFirst({
    orderBy: {
      featuredHome_timestamp: "desc",
    },
  });

const categories = await getFeaturedSectionsCategories();
---

<Layout title="Nouse" active="home" style="nouse">
  <main>
    <div class="px-[3%] pt-8 sm:px-[0.5%] 2xl:px-[13%]">
      <div id="featured-articles">
        <FeaturedArticles
          featuredArticlesIds={featuredArticlesIds?.featuredHome_articles
            ?.split(",")
            .map(Number)}
          style="nouse"
        />
      </div>
      <BannerEdition />
    </div>
    <Muse />
    <div class="featured-sections px-[3%] pt-8 sm:px-[0.5%] 2xl:px-[13%]">
      {
        categories.map((category) => (
          <div id={`${category.categories_name}-section`}>
            <FeaturedSection category={category} />
          </div>
        ))
      }
    </div>
  </main>
</Layout>

<script define:vars={{ categories }}>
  const desktopNav = document.querySelector("#desktopNav");
  const mobileHeader = document.querySelector("#mobileHeader");
  const mobileNouseLogo = document.querySelector("#mobileHeader img");
  window.onscroll = function () {
    categories.forEach((category) => {
      if (
        window.pageYOffset >=
        document.getElementById(`${category.categories_name}-section`)
          .offsetTop -
          50
      ) {
        desktopNav.style.setProperty(
          "--computedBaseColour",
          category.categories_backgroundColor
        );
        mobileHeader.style.setProperty(
          "--computedBaseColour",
          category.categories_backgroundColor
        );
        mobileHeader.classList.remove("text-black");
        mobileHeader.classList.add("text-white");
        mobileNouseLogo.classList.add("invert");
      } else if (
        window.pageYOffset <
        document.querySelector(".featured-sections div:nth-child(1)")
          .offsetTop -
          50
      ) {
        desktopNav.style.setProperty("--computedBaseColour", "#000");
        mobileHeader.style.setProperty("--computedBaseColour", "#F5EFEB");
        mobileHeader.classList.remove("text-white");
        mobileHeader.classList.add("text-black");
        mobileNouseLogo.classList.remove("invert");
      }
    });
  };
</script>
