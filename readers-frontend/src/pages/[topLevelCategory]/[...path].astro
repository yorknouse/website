---
import FeaturedArticles from "@components/FeaturedArticles.astro";
import FeaturedSection from "@components/FeaturedSection.astro";
import Paginator from "@solidComponents/Paginator";
import { getCategoriesWithArticles } from "@componentsUtils/categories";
import Layout from "@layouts/Layout.astro";
import NavbarColourSwitcher from "@components/NavbarColourSwitcher.astro";
import ArticleRows from "@components/ArticleRows.astro";
import type { ArticleCategory } from "@components/types";
import { getCategoryLink } from "@componentsUtils/categories";
import type { ICategoryArticles } from "@components/types";

const { topLevelCategory, path } = Astro.params;
const cleanPath = path ? decodeURIComponent(path) : undefined;

// Getting the category name and page number
let categoryName: string | undefined;
let pageNumber: number = 0;
let paginatorPrefix: string | undefined;
// if the path is undefined, then the category is the top level category for example /news
if (cleanPath === undefined) {
  categoryName = topLevelCategory;
  paginatorPrefix = topLevelCategory;
} else {
  const pathComponents = cleanPath.split("/");
  // If the last component is a number for example, then it's a page number
  // For example /news/2 or /news/campus-news/2 Otherwise, it's a category name for example /news/campus-news
  if (
    !Number.isNaN(Number.parseInt(pathComponents[pathComponents.length - 1]))
  ) {
    // If there's only one component, then it's the category is the topLevelCategory
    // For example, /news/2. Otherwise, it's the second to last component for example /news/campus-news/2
    if (pathComponents.length === 1) {
      categoryName = topLevelCategory;
      paginatorPrefix = topLevelCategory;
    } else {
      categoryName = pathComponents[pathComponents.length - 2];
      paginatorPrefix = `${topLevelCategory}/${pathComponents
        .slice(0, pathComponents.length - 1)
        .join("/")}`;
    }
    pageNumber = Number.parseInt(pathComponents[pathComponents.length - 1]);
  } else {
    categoryName = pathComponents[pathComponents.length - 1];
    paginatorPrefix = `${topLevelCategory}/${pathComponents.join("/")}`;
  }
}

// Redirecting to 404 if the page number is 1 as we paginate from 0
if (pageNumber === 1 || categoryName === undefined) {
  return Astro.redirect("/404");
} else if (pageNumber > 1) {
  pageNumber -= 1;
}

const articlesPerPage = 30; // Number of articles per page
const isMuseLandingPage = categoryName === "muse" && pageNumber === 0; // Whether the page is the muse landing page
const articlesSkipped = isMuseLandingPage // Number of articles to skip
  ? 0
  : categoryName === "muse"
    ? (pageNumber - 1) * articlesPerPage
    : pageNumber * articlesPerPage;

const apiBase = import.meta.env.PUBLIC_API_BASE_URL;

let resFeatured = await fetch(
  `${apiBase}/api/frontend/categories/${categoryName}/featured`,
);
const categoryFeatured: {
  categories_featured: string | null;
} | null = await resFeatured.json();

let resCount = await fetch(
  `${apiBase}/api/frontend/categories/${categoryName}/count`,
);
const categoryCount: {
  _count: {
    articles: number;
  };
} | null = await resCount.json();

// Getting the featured article ids
const featuredArticlesIds =
  categoryFeatured?.categories_featured &&
  categoryFeatured.categories_featured !== ""
    ? categoryFeatured.categories_featured.split(",").map(Number)
    : [];

// Redirecting to 404 if the category doesn't exist
// Or if there are no articles to display and the page number isn't 0
// Note: the second condition allows us to show landing pages for categories with no articles
if (
  !categoryCount ||
  (categoryCount._count.articles -
    (articlesSkipped + featuredArticlesIds.length) <=
    0 &&
    pageNumber !== 0)
)
  return Astro.redirect("/404");

const formData = new FormData();
formData.append("take", String(isMuseLandingPage ? 0 : articlesPerPage));
formData.append("skip", String(articlesSkipped));
formData.append("notInFeatured", String(featuredArticlesIds));

let res = await fetch(
  `${apiBase}/api/frontend/categories/${categoryName}/page`,
  {
    method: "POST",
    body: formData,
  },
);

const category: ICategoryArticles = await res.json();

// Redirecting to 404 if the category doesn't exist or if there are no articles to show
if (!category) return Astro.redirect("/404");

// Getting the style for the category
const style =
  category.categories_nestUnder === 4 ||
  topLevelCategory === "muse" ||
  category.categories_name === "muse"
    ? "muse"
    : "nouse";

// Getting the featured section for the muse homepage
let museCategories: ICategoryArticles[] = [];
if (isMuseLandingPage) {
  museCategories = await getCategoriesWithArticles(4);
}

const cat: ArticleCategory = {
  id: category.categories_id,
  name: category.categories_name,
  displayName: category.categories_displayName,
  colour: category.categories_backgroundColor,
  link: getCategoryLink(
    String(category.categories_name),
    Number(category.categories_nestUnder),
  ),
  nestUnder: Number(category.categories_nestUnder),
};
---

<Layout
  title={`${category.categories_displayName} - Nouse`}
  active={category.categories_name}
  style={style}
>
  <div class="px-[3%] pt-8 sm:px-[0.5%] 2xl:px-[13%]">
    {/* Mobile Header */}
    {
      category.categories_name !== "muse" && (
        <h1 id="mobile-header" class="block text-center text-2xl sm:hidden">
          {category.categories_displayName}
        </h1>
      )
    }
    {
      featuredArticlesIds.length !== 0 && (
        <>
          <div id="featured-articles">
            <FeaturedArticles
              featuredArticlesIds={featuredArticlesIds}
              hideCategoryAccent={category.categories_name !== "muse"}
              style={style}
            />
          </div>
          {!isMuseLandingPage && (
            <hr class="my-2.5 w-full self-center border-gray-300" />
          )}
        </>
      )
    }
    {
      !isMuseLandingPage ? (
        <>
          <div id="article-list">
            <ArticleRows
              articles={category.articles!}
              hideCategoryAccent={true}
            />
          </div>
        </>
      ) : (
        <>
          <div class="featured-sections">
            {museCategories.map((category) => (
              <div id={`${category.categories_name}-section`}>
                <FeaturedSection category={category} style={"muse"} />
              </div>
            ))}
          </div>
        </>
      )
    }
  </div>
  <div class="mt-4 w-full" id="paginator-container">
    <Paginator
      client:only
      page={pageNumber}
      pages={category.categories_name === "muse"
        ? Math.ceil(
            (categoryCount._count.articles - featuredArticlesIds.length) /
              articlesPerPage,
          ) + 1
        : Math.max(
            1,
            Math.ceil(categoryCount._count.articles / articlesPerPage),
          )}
      pagesToDisplay={5}
      prefix={paginatorPrefix}
    />
  </div>
  <NavbarColourSwitcher featuredCategories={museCategories} style={"muse"} />
</Layout>
