---
import ArticleRows from "@components/ArticleRows.astro";
import CustomBoxes from "@solidComponents/CustomBoxes";
import type { FeaturedHighlights } from "@components/types";
import { getArticles } from "@componentsUtils/articles";
import Layout from "@layouts/Layout.astro";
import { v4 as uuidv4 } from "uuid";
import type { S3URL } from "@components/types";
import type { IEdition } from "@components/types";

const { slug } = Astro.params;

const cleanSlug = decodeURIComponent(slug || "");

// --- Read cookies ---
const previewToken = Astro.cookies.get("previewToken")?.value;

// --- Read query params for legacy preview ---
const urlSearchParams = new URLSearchParams(Astro.url.search);
const preview = urlSearchParams.get("preview");
const hash = urlSearchParams.get("hash");

// --- Build fetch options ---
const headers: Record<string, string> = {};

// Prefer cookie token if available
if (previewToken && previewToken.length > 0) {
  headers["Authorization"] = `Bearer ${previewToken}`;
}
// Fallback to legacy query param preview
if (preview && preview.length > 0 && hash && hash.length > 0) {
  headers["X-Preview-Hash"] = hash; // optional header; backend can read it
}

const apiBase = import.meta.env.PUBLIC_API_BASE_URL;

const res = await fetch(`${apiBase}/api/frontend/editions/` + cleanSlug, {
  headers: headers,
});
const edition: IEdition = await res.json();

if (!edition) return Astro.redirect("/404");

const isWebEdition = edition.editions_type === "Web Edition";
let pdfURL;
let tempFileId;
// Data for web editions is saved as a JSON string in the database
// This is parsed into an object here
let featuredHighlights: FeaturedHighlights = null;
if (isWebEdition && edition.editions_featuredHighlights) {
  featuredHighlights = JSON.parse(edition.editions_featuredHighlights);
  if (featuredHighlights) {
    for (const section of featuredHighlights.sections) {
      if (section.articles.length !== 0) {
        const articleIds = section.articles.map((n) => Number.parseInt(n));
        section.articlesData = await getArticles("nouse", articleIds);
      }
      // If there is a custom box header, add it to the start of the custom boxes array
      if (section.customBoxHeader.title) {
        section.customBoxes.splice(0, 0, section.customBoxHeader);
      }
    }
  }
} else if (edition.editions_pdf) tempFileId = edition.editions_pdf;
else tempFileId = edition.editions_pdfOriginal;

if (tempFileId) {
  const res = await fetch(`${apiBase}/api/s3url/${tempFileId}?size=false`);
  const s3url: S3URL = await res.json();
  pdfURL = s3url.url;
}
---

<Layout
  title={`${
    edition.editions_printNumber
      ? `№${edition.editions_printNumber}`
      : edition.editions_name
  } - Nouse`}
  active={undefined}
  style={"nouse"}
>
  <div class="px-[3%] pt-8 sm:px-[0.5%] 2xl:px-[13%]">
    <h1 class="text-center text-xl md:text-2xl lg:text-4xl">
      {
        preview &&
          preview.length > 0 &&
          hash &&
          hash.length > 0 &&
          previewToken &&
          previewToken.length > 0 && (
            <span class="italic underline">DRAFT&nbsp;</span>
          )
      }
      {
        edition.editions_printNumber
          ? `№${edition.editions_printNumber}`
          : edition.editions_name
      }
    </h1>
    {
      (isWebEdition ||
        edition.editions_printNumber ||
        new Date(edition.editions_name).toString() === "Invalid Date") && (
        <h4 class="text-center text-lg md:text-xl">{`Published on ${edition.editions_published.toLocaleString(
          "en-gb",
          { day: "numeric", month: "long", year: "numeric" },
        )}`}</h4>
      )
    }
  </div>
  {
    isWebEdition && featuredHighlights ? (
      async () => {
        const res = await fetch(
          `${apiBase}/api/s3url/${edition.editions_thumbnail!}?size=medium`,
        );
        const s3url: S3URL = await res.json();
        return (
          <div class="mt-8">
            <img
              id="thumbnail"
              class="mb-5 w-full px-[3%] sm:px-[0.5%] 2xl:px-[13%]"
              src={s3url.url}
              alt="Edition thumbnail"
            />
            {featuredHighlights!.sections.map(async (section) => {
              const res = await fetch(
                `${apiBase}/api/s3url/${section.headerImage}?size=medium`,
              );
              const s3url: S3URL = await res.json();
              return (
                <div class="section mb-8">
                  {section.headerImage && (
                    <img
                      class="section-image mb-5 w-full px-[3%] sm:px-[0.5%] 2xl:px-[13%]"
                      src={s3url.url}
                      alt="Featured highlight section header image"
                    />
                  )}
                  {section.customBoxes.length !== 0 &&
                    (() => {
                      const id = uuidv4();
                      return (
                        <div class="custom-boxes-container relative mb-5 flex w-full flex-col bg-black px-[3%] pt-4 text-white sm:px-[0.5%] 2xl:px-[13%]">
                          <p class="border-b border-white text-center text-xl md:text-2xl lg:text-4xl">
                            From Our Editors
                          </p>
                          <CustomBoxes
                            client:idle
                            id={id}
                            customBoxes={section.customBoxes}
                          >
                            {section.customBoxes.map((customBox, index) => {
                              return (
                                <div
                                  id={`${id}-${index}`}
                                  class={`custom-box flex flex-col items-center justify-start overflow-hidden bg-neutral-900 transition-opacity delay-300 duration-500 ${
                                    index == 0
                                      ? "w-full p-4 opacity-100 md:w-10/12"
                                      : "h-0 w-0 p-0 opacity-0"
                                  }`}
                                >
                                  <p class="text-center text-lg underline md:text-xl lg:text-2xl">
                                    {customBox.title}
                                  </p>
                                  <p class="text-center text-xs xl:text-sm 2xl:text-base">
                                    {customBox.text}
                                  </p>
                                </div>
                              );
                            })}
                          </CustomBoxes>
                        </div>
                      );
                    })}
                  {section.articles.length !== 0 && (
                    <div class="px-[3%] sm:px-[0.5%] 2xl:px-[13%]">
                      <ArticleRows articles={section.articlesData} />
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        );
      }
    ) : (
      <>
        <div class="mx-auto w-1/2 pt-8">
          <iframe src={pdfURL} width="100%" height="1170" />
          <p class="mt-4 text-center text-lg md:text-xl">
            If you're unable to view the PDF file,
            <a href={pdfURL}>click here.</a>
          </p>
        </div>
      </>
    )
  }
</Layout>
