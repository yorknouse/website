---
import Article from "@components/Article.astro";
import ArticleCookieManager from "@components/ArticleCookieManager.astro";
import TopArticles from "@solidComponents/TopArticles";
import { Icon } from "astro-icon/components";
import Layout from "@layouts/Layout.astro";
import type { IArticle, S3URL } from "@components/types";
import Gallery from "@solidComponents/Gallery";

const { year, month, day, slug } = Astro.params;

const cleanSlug = decodeURIComponent(slug || "");

const apiBase = import.meta.env.PUBLIC_API_BASE_URL;
const base = import.meta.env.PUBLIC_BASE_URL;

// --- Read cookies ---
const previewToken = Astro.cookies.get("previewToken")?.value;

// --- Read query params for legacy preview ---
const urlSearchParams = new URLSearchParams(Astro.url.search);
const preview = urlSearchParams.get("preview");
const hash = urlSearchParams.get("hash");

// --- Build fetch options ---
const headers: Record<string, string> = {};

// Prefer cookie token if available
if (previewToken && previewToken.length > 0) {
  headers["Authorization"] = `Bearer ${previewToken}`;
}
// Fallback to legacy query param preview
if (preview && preview.length > 0 && hash && hash.length > 0) {
  headers["X-Preview-Hash"] = hash; // optional header; backend can read it
}

const res = await fetch(`${apiBase}/api/frontend/articles/` + cleanSlug, {
  headers: headers,
});
const article: IArticle = await res.json();

if (!article) return Astro.redirect("/404");

if (!article.categories || article.categories.length == 0) {
  console.error("No categories exist");
  return Astro.redirect("/404");
}
const topCategory = article.categories[0];

const bottomCategory = article.categories[article.categories.length - 1];

// We only want to display 4 similar articles.
// However, when querying the similar articles we get 5,
// so that we can filter the same article out as above.
// If the same article is not in the list, we truncate the list.
if (article.similarArticles!.length > 4) article.similarArticles!.pop();

const imagePlaceHolder =
  '"https://bbcdn.nouse.co.uk/file/nousePublicBackendUploads/db/webUploads/public/ARTICLE-THUMBNAIL/mWMFA4fY1ENg25x%20breakingNews_large.jpg"';

let galleryImages: string[] = [];

if (
  article.articleType === 2 &&
  article.text != null &&
  article.text.length > 0
) {
  let draftText = article.text;
  const imageIds = draftText
    .split(",")
    .map((idStr) => parseInt(idStr.trim()))
    .filter((id) => !isNaN(id));

  galleryImages = await Promise.all(
    imageIds.map(async (id) => {
      const res = await fetch(`${apiBase}/api/s3url/${id}?size=large`);
      const s3url: S3URL = await res.json();
      return s3url.url;
    }),
  );
}
---

<Layout
  style={topCategory.id === 4 ? "muse" : "nouse"}
  active={bottomCategory.name}
  title={`${article.headline} - Nouse`}
>
  <main>
    <div class="flex flex-col px-[3%] pt-8 text-base sm:px-[0.5%] 2xl:px-[13%]">
      <div class="flex flex-col md:flex-row md:gap-10">
        {/* Article */}
        <div class="flex w-full flex-col gap-3 md:w-2/3">
          <h1
            class="text-2xl sm:text-3xl md:text-4xl lg:text-6xl"
            id="article-title"
          >
            {
              preview &&
                preview.length > 0 &&
                hash &&
                hash.length > 0 &&
                previewToken &&
                previewToken.length > 0 && (
                  <span class="italic underline">DRAFT&nbsp;</span>
                )
            }
            {article.headline}
          </h1>
          {
            article.published && (
              <div class="flex flex-row font-semibold">
                <Icon
                  name="ic:baseline-access-time-filled"
                  class="my-auto mr-1 h-4 w-4"
                />
                <p class="my-auto" id="article-timestamp">
                  {article.published}
                </p>
              </div>
            )
          }
          <h3 id="article-excerpt">
            {article.excerpt}
          </h3>
          {
            article.isThumbnailPortrait ? (
              <img
                id="article-image"
                class="max-w-1/2 mx-auto aspect-portrait-video rounded-lg object-cover"
                src={article.thumbnailURL}
                onerror={`if (this.src !== ${imagePlaceHolder}) this.src = ${imagePlaceHolder}`}
                alt="Article Image"
              />
            ) : (
              <img
                id="article-image"
                class="aspect-video rounded-lg object-cover"
                src={article.thumbnailURL}
                onerror={`if (this.src !== ${imagePlaceHolder}) this.src = ${imagePlaceHolder}`}
                alt="Article Image"
              />
            )
          }
          <div class="relative h-5">
            <div
              class={`absolute top-0 left-0 border-l-[5px] h-full border-color-${article.parentCategory?.name}`}
            >
            </div>
            <p
              class={`ml-2 category-color-${article.parentCategory?.name}`}
              id="article-credits"
            >
              Image by {article.thumbnailCredit}
            </p>
          </div>
          <p class="text-xl italic">
            <span class={`category-color-${article.parentCategory?.name}`}
              >By
            </span>
            {
              article.authors.map((author, index) => {
                if (index === 0) {
                  return (
                    <a href={`/author/${author.users_userid}`}>
                      {`${author.users_name1} ${author.users_name2}`}
                    </a>
                  );
                } else if (index === article.authors.length - 1) {
                  return (
                    <>
                      <span
                        class={`category-color-${article.parentCategory?.name}`}
                      >
                        {" "}
                        and{" "}
                      </span>
                      <a href={`/author/${author.users_userid}`}>
                        {author.users_name1} {author.users_name2}
                      </a>
                    </>
                  );
                } else {
                  return (
                    <>
                      <span
                        class={`category-color-${article.parentCategory?.name}`}
                      >
                        ,{" "}
                      </span>
                      <a href={`/author/${author.users_userid}`}>
                        {author.users_name1} {author.users_name2}
                      </a>
                    </>
                  );
                }
              })
            }
          </p>
          {
            preview &&
              preview.length > 0 &&
              hash &&
              hash.length > 0 &&
              previewToken &&
              previewToken.length > 0 && (
                <p class="italic underline text-xl">
                  DRAFT Please note that this article is currently a draft and
                  therefore is not publicly visible DRAFT
                </p>
              )
          }
          {
            article.articleType == 2 ? (
              <div class="gallery">
                {galleryImages.length > 0 && (
                  <>
                    <p>
                      <i>Click image to expand</i>
                    </p>
                    <Gallery client:load images={galleryImages} />
                  </>
                )}
              </div>
            ) : (
              <div
                id="article-content"
                class="whitespace-pre-wrap text-justify"
                set:html={article.text}
              />
            )
          }
        </div>
        <style>
          .gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 5px; /* 5px margin between images */
            justify-content: flex-start;
            margin: -5px;
          }

          .gallery-img {
            margin: 5px;
            //max-width: 400px;
            max-width: calc(25% - 10px);
            height: auto;
            object-fit: cover;
            flex-shrink: 0;
          }

          @media (max-width: 1024px) {
            .gallery-img {
              max-width: calc(33.33% - 10px);
            }
          }

          @media (max-width: 768px) {
            .gallery-img {
              max-width: calc(50% - 10px);
            }
          }

          @media (max-width: 480px) {
            .gallery-img {
              max-width: calc(100% - 10px);
            }
          }
        </style>
        {/* Top Articles */}
        <div class="flex w-full flex-col md:w-1/3">
          <TopArticles client:only base={base} />
        </div>
      </div>
      {/* Similar Articles */}
      <div class="mt-10 border-t border-whiteish-200">
        <h3 class="block py-2 text-4xl">Similar Articles</h3>
        <div
          class="flex h-min flex-col md:flex-row"
          id="similar-articles-container"
        >
          {
            article.similarArticles!.map(async (similarArticle, i) => (
              <div
                class={`mt-4 w-full border-b-whiteish-200 border-r-whiteish-200 pb-4 md:mt-0 md:max-w-[25%] md:pb-0 ${
                  i < article.similarArticles!.length - 1
                    ? "border-b border-r-0 md:border-b-0 md:border-r"
                    : "border-0"
                } md:pr-4 ${i > 0 ? "md:ml-4" : "md:ml-0"}`}
              >
                <div class="h-min">
                  <Article
                    headline={
                      similarArticle.headline!.length != 0
                        ? similarArticle.headline!
                        : "Unknown"
                    }
                    excerpt={null}
                    authors={similarArticle.authors}
                    category={undefined}
                    categoryLink={undefined}
                    categoryColor={similarArticle.parentCategory.colour}
                    imageUrl={similarArticle.thumbnailURL}
                    articleUrl={similarArticle.articleURL}
                    isVertical={true}
                    isPortrait={similarArticle.isThumbnailPortrait}
                    hideCategoryAccent={true}
                  />
                </div>
              </div>
            ))
          }
        </div>
      </div>
      <ArticleCookieManager articleId={article.id} />
    </div>
  </main>
</Layout>
