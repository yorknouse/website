---
import MuseComponent from "@solidComponents/MuseComponent";
import { getMenuCategories } from "@componentsUtils/categories";
import { getArticles } from "@componentsUtils/articles";
import type { IArticleFull, ICategory, MuseNavbarCategory } from "./types";
import Article from "./Article.astro";

const museMenuCategoriesRaw = await getMenuCategories("muse");

let museMenuCategories: ICategory[] = [];
let categories: MuseNavbarCategory[] = [];

if (museMenuCategoriesRaw !== undefined) {
  museMenuCategories = museMenuCategoriesRaw.filter(
    (category) => category.categories_name !== "nouse",
  );

  categories = museMenuCategories.reduce((accumulator, currentCategory) => {
    accumulator.push({
      name: currentCategory.categories_name,
      displayName: currentCategory.categories_displayName
        ? currentCategory.categories_displayName
        : "",
    });

    return accumulator;
  }, [] as MuseNavbarCategory[]);
}

const articles = new Map<string, IArticleFull[]>();

const allFeaturedArticleIds = museMenuCategories.flatMap(
  (c) => c.categories_featured?.split(",").map(Number) ?? [],
);

const allArticles = await getArticles("muse", allFeaturedArticleIds);

for (const category of museMenuCategories) {
  const featuredIds =
    category.categories_featured?.split(",").map(Number) ?? [];
  const categoryArticles: IArticleFull[] = allArticles
    .filter((a) => featuredIds.includes(a.id))
    .slice(0, 4)
    .map((a) => ({
      ...a,
    }));

  articles.set(category.categories_name, categoryArticles);
}
---

<div class="relative mt-4 flex w-full flex-col bg-black" id="muse-banner">
  <a href="/muse" class="flex w-full flex-row">
    <img
      class="mx-auto my-4 w-[27%] md:w-[14%]"
      src="https://bbcdn.nouse.co.uk/file/nouseSiteAssets/logo/MUSE%20Logo%20White%20small.png"
      alt="Nouse MUSE logo"
    />
  </a>

  <MuseComponent client:idle categories={categories}>
    {
      museMenuCategories.map((category, i) => (
        <>
          {/* Desktop */}
          <div
            class={`${
              i === 0 ? "my-4 h-min opacity-100" : "h-0 opacity-0"
            } hidden w-full flex-row px-[0.5%] transition-opacity delay-100 duration-700 md:flex 2xl:px-[13%]`}
            id={`muse_${category.categories_name}`}
          >
            {articles.get(category.categories_name)?.map((article, i) => (
              <div
                class={`mr-3 flex w-1/4 flex-row ${
                  i !== articles.get(category.categories_name)!.length - 1 &&
                  "border-r border-white"
                }`}
              >
                <div class="pr-3">
                  <Article
                    headline={
                      article.headline?.length != 0
                        ? String(article.headline)
                        : "Unknown"
                    }
                    excerpt={
                      article.excerpt?.length != 0 ? article.excerpt : "Unknown"
                    }
                    authors={article.authors}
                    category={undefined}
                    categoryColor={"#FFF"}
                    categoryLink={undefined}
                    imageUrl={article.thumbnailURL}
                    articleUrl={article.articleURL}
                    isVertical={true}
                    isPortrait={article.isThumbnailPortrait}
                    hideCategoryAccent={true}
                    textColour={"#FFF"}
                  />
                </div>
              </div>
            ))}
          </div>

          {/* Mobile */}
          <div
            class={`${
              i === 0 ? "my-4 h-min w-full opacity-100" : "h-0 w-0 opacity-0"
            } flex flex-col px-4 transition-opacity delay-100 duration-500 md:hidden 2xl:px-[13%]`}
            id={`muse_mobile_${category.categories_name}`}
          >
            {articles.get(category.categories_name)?.map((article, i) => (
              <div class="flex w-full flex-col">
                {i !== 0 && (
                  <hr class="my-2.5 w-full self-center border-white" />
                )}
                <Article
                  headline={
                    article.headline?.length != 0
                      ? String(article.headline)
                      : "Unknown"
                  }
                  excerpt={
                    article.excerpt?.length != 0 ? article.excerpt : "Unknown"
                  }
                  authors={article.authors}
                  category={undefined}
                  categoryColor={"#FFF"}
                  categoryLink={undefined}
                  imageUrl={article.thumbnailURL}
                  articleUrl={article.articleURL}
                  isVertical={false}
                  isPortrait={article.isThumbnailPortrait}
                  hideCategoryAccent={true}
                  textColour={"#FFF"}
                />
              </div>
            ))}
          </div>
        </>
      ))
    }
  </MuseComponent>
</div>
